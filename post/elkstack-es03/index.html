
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Ghost Stories">
    <title>Elasticsearch性能优化 - Ghost Stories</title>
    <meta name="author" content="Ghost Stories">
    
    
        <link rel="icon" href="http://wangnan.tech/assets/images/favicon.ico">
    
    
    <meta property="og:type" content="blog">
<meta property="og:title" content="Elasticsearch性能优化">
<meta property="og:url" content="http://wangnan.tech/post/elkstack-es03/index.html">
<meta property="og:site_name" content="Ghost Stories">
<meta property="og:image" content="http://onxkn9cbz.bkt.clouddn.com/07.jpg">
<meta property="og:image" content="http://chenlinux.com/images/uploads/splunk-event-pattern.png">
<meta property="og:updated_time" content="2017-11-27T03:14:58.224Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elasticsearch性能优化">
<meta name="twitter:image" content="http://onxkn9cbz.bkt.clouddn.com/07.jpg">
<meta name="twitter:creator" content="@twitter">
    
        <link rel="publisher" href="https://plus.google.com/google_plus_business"/>
    
    
        
    
    
        <meta property="og:image" content="http://wangnan.tech/assets/images/ice_bear.jpg"/>
    
    
        <meta property="og:image" content="http://onxkn9cbz.bkt.clouddn.com/07.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://onxkn9cbz.bkt.clouddn.com/07.jpg" />
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-sxklfps8ywgfyyjcowvnb4gxdgt0zjts3hsguljmv9uqanxjbnitrovtbrek.min.css">
    <!--STYLES END-->
    
    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?0df8e38c5e76634531942b2634b055eb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Ghost Stories</a>
    </div>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="/about">
        
        
            <i class="fa fa-lg fa-favicon.ico"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/ice_bear.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Ghost Stories</h4>
                
                    <h5 class="sidebar-profile-bio"><p>2gether thru life</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                        <span class="sidebar-button-desc">home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                        <span class="sidebar-button-desc">categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                        <span class="sidebar-button-desc">tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                        <span class="sidebar-button-desc">archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/read"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-book"></i>
                        <span class="sidebar-button-desc">read</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/about"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                        <span class="sidebar-button-desc">about</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/wangnan9279" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/wangnan9279" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://onxkn9cbz.bkt.clouddn.com/gmail.png" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://onxkn9cbz.bkt.clouddn.com/wechat-samll.jpg" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-comments"></i>
                        <span class="sidebar-button-desc">Wechat</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://www.jianshu.com/u/244399b1d776" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-desktop"></i>
                        <span class="sidebar-button-desc">JianShu</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://zhuanlan.zhihu.com/c_121958856" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-coffee"></i>
                        <span class="sidebar-button-desc">Zhihu</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Elasticsearch性能优化
        </h1>
    
    
        <div class="post-meta">
    <time itemprop="datePublished" datetime="2017-11-27T10:46:05+08:00">
	
		    Nov 27, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/ELKstack/">ELKstack</a>


    
</div>

    
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p><span><br><a id="more"></a><br><img src="http://onxkn9cbz.bkt.clouddn.com/07.jpg" alt=""><br><h1 id="table-of-contents">Table of Contents</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#目录"><span class="toc-text">目录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#批量提交"><span class="toc-text">批量提交</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bulk-size"><span class="toc-text">bulk size</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gateway"><span class="toc-text">gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#共享存储上的影子副本"><span class="toc-text">共享存储上的影子副本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#集群状态维护"><span class="toc-text">集群状态维护</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#批量新索引创建"><span class="toc-text">批量新索引创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#过多字段持续更新"><span class="toc-text">过多字段持续更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nested-object"><span class="toc-text">nested object</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#缓存"><span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#filter-cache"><span class="toc-text">filter cache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shard-request-cache"><span class="toc-text">shard request cache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#field-stats-接口"><span class="toc-text">field_stats 接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#字段数据"><span class="toc-text">字段数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Circuit-Breaker"><span class="toc-text">Circuit Breaker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#doc-values"><span class="toc-text">doc values</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#curator"><span class="toc-text">curator</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#参数介绍"><span class="toc-text">参数介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用示例"><span class="toc-text">常用示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#profiler"><span class="toc-text">profiler</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#query"><span class="toc-text">query</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aggs"><span class="toc-text">aggs</span></a></li></ol></li></ol></span></p>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>批量提交</li>
<li>gateway</li>
<li>集群状态维护</li>
<li>缓存</li>
<li>字段数据</li>
<li>curator</li>
<li>profiler</li>
</ul>
<h1 id="批量提交"><a href="#批量提交" class="headerlink" title="批量提交"></a>批量提交</h1><p>在 CRUD 章节，我们已经知道 ES 的数据写入是如何操作的了。喜欢自己动手的读者可能已经迫不及待的自己写了程序开始往 ES 里写数据做测试。这时候大家会发现：程序的运行速度非常一般，即使 ES 服务运行在本机，一秒钟大概也就能写入几百条数据。</p>
<p>这种速度显然不是 ES 的极限。事实上，每条数据经过一次完整的 HTTP POST 请求和 ES indexing 是一种极大的性能浪费，为此，ES 设计了批量提交方式。在数据读取方面，叫 mget 接口，在数据变更方面，叫 bulk 接口。mget 一般常用于搜索时 ES 节点之间批量获取中间结果集，对于 Elastic Stack 用户，更常见到的是 bulk 接口。</p>
<p>bulk 接口采用一种比较简朴的数据积累格式，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># curl -XPOST http://127.0.0.1:9200/_bulk -d&apos;</div><div class="line">&#123; &quot;create&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot;  &#125; &#125;</div><div class="line">&#123; &quot;field1&quot; : &quot;value1&quot; &#125;</div><div class="line">&#123; &quot;delete&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot; &#125; &#125;</div><div class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</div><div class="line">&#123; &quot;field1&quot; : &quot;value2&quot; &#125;</div><div class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;1&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_index&quot; : &quot;test&quot;&#125; &#125;</div><div class="line">&#123; &quot;doc&quot; : &#123;&quot;field2&quot; : &quot;value2&quot;&#125; &#125;</div><div class="line">&apos;</div></pre></td></tr></table></figure>
<p>格式是，每条 JSON 数据的上面，加一行描述性的元 JSON，指明下一行数据的操作类型，归属索引信息等。</p>
<p>采用这种格式，而不是一般的 JSON 数组格式，是因为接收到 bulk 请求的 ES 节点，就可以不需要做完整的 JSON 数组解析处理，直接按行处理简短的元 JSON，就可以确定下一行数据 JSON 转发给哪个数据节点了。这样，一个固定内存大小的 network buffer 空间，就可以反复使用，又节省了大量 JVM 的 GC。</p>
<p>事实上，产品级的 logstash、rsyslog、spark 都是默认采用 bulk 接口进行数据写入的。对于打算自己写程序的读者，建议采用 Perl 的 <code>Search::Elasticsearch::Bulk</code> 或者 Python 的 <code>elasticsearch.helpers.*</code> 库。</p>
<h2 id="bulk-size"><a href="#bulk-size" class="headerlink" title="bulk size"></a>bulk size</h2><p>在配置 bulk 数据的时候，一般需要注意的就是请求体大小(bulk size)。</p>
<p>这里有一点细节上的矛盾，我们知道，HTTP 请求，是可以通过 HTTP 状态码 <em>100 Continue</em> 来持续发送数据的。但对于 ES 节点接收 HTTP 请求体的 <em>Content-Length</em> 来说，是按照整个大小来计算的。所以，首先，要确保 bulk 数据不要超过 <code>http.max_content_length</code> 设置。</p>
<p>那么，是不是尽量让 bulk size 接近这个数值呢？当然不是。</p>
<p>依然是请求体的问题，因为请求体需要全部加载到内存，而 JVM Heap 一共就那么多(按 31GB 算)，过大的请求体，会挤占其他线程池的空间，反而导致写入性能的下降。</p>
<p>再考虑网卡流量，磁盘转速的问题，所以一般来说，建议 bulk 请求体的大小，在 15MB 左右，通过实际测试继续向上探索最合适的设置。</p>
<p>注意：这里说的 15MB 是请求体的字节数，而不是程序里里设置的 bulk size。bulk size 一般指数据的条目数。不要忘了，bulk 请求体中，每条数据还会额外带上一行元 JSON。</p>
<p>以 logstash 默认的 <code>bulk_size =&gt; 5000</code> 为例，假设单条数据平均大小 200B ，一次 bulk 请求体的大小就是 1.5MB。那么我们可以尝试 <code>bulk_size =&gt; 50000</code>；而如果单条数据平均大小是 20KB，一次 bulk 大小就是 100MB，显然超标了，需要尝试下调至 <code>bulk_size =&gt; 500</code>。</p>
<h1 id="gateway"><a href="#gateway" class="headerlink" title="gateway"></a>gateway</h1><p>gateway 是 ES 设计用来长期存储索引数据的接口。一般来说，大家都是用本地磁盘来存储索引数据，即 <code>gateway.type</code> 为 <code>local</code>。</p>
<p>数据恢复中，有很多策略调整我们已经在之前分片控制小节讲过。除开分片级别的控制以外，gateway 级别也还有一些可优化的地方：</p>
<ul>
<li><p>gateway.recover_after_nodes<br>该参数控制集群在达到多少个节点的规模后，才开始数据恢复任务。这样可以避免集群自动发现的初期，分片不全的问题。</p>
</li>
<li><p>gateway.recover_after_time<br>该参数控制集群在达到上条配置设置的节点规模后，再等待多久才开始数据恢复任务。</p>
</li>
<li><p>gateway.expected_nodes<br>该参数设置集群的预期节点总数。在达到这个总数后，即认为集群节点已经完全加载，即可开始数据恢复，不用再等待上条设置的时间。</p>
</li>
</ul>
<p>注意：gateway 中说的节点，仅包括主节点和数据节点，纯粹的 client 节点是不算在内的。如果你有更明确的选择，也可以按需求写：</p>
<ul>
<li>gateway.recover_after_data_nodes</li>
<li>gateway.recover_after_master_nodes</li>
<li>gateway.expected_data_nodes</li>
<li>gateway.expected_master_nodes</li>
</ul>
<h2 id="共享存储上的影子副本"><a href="#共享存储上的影子副本" class="headerlink" title="共享存储上的影子副本"></a>共享存储上的影子副本</h2><p>虽然 ES 对 gateway 使用 NFS，iscsi 等共享存储的方式极力反对，但是对于较大量级的索引的副本数据，ES 从 1.5 版本开始，还是提供了一种节约成本又不特别影响性能的方式：影子副本(shadow replica)。</p>
<p>首先，需要在集群各节点的 <code>elasticsearch.yml</code> 中开启选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node.enable_custom_paths: true</div></pre></td></tr></table></figure>
<p>同时，确保各节点使用相同的路径挂载了共享存储，且目录权限为 Elasticsearch 进程用户可读可写。</p>
<p>然后，创建索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># curl -XPUT &apos;http://127.0.0.1:9200/my_index&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">    &quot;index&quot; : &#123;</div><div class="line">        &quot;number_of_shards&quot; : 1,</div><div class="line">        &quot;number_of_replicas&quot; : 4,</div><div class="line">        &quot;data_path&quot;: &quot;/var/data/my_index&quot;,</div><div class="line">        &quot;shadow_replicas&quot;: true</div><div class="line">    &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>针对 shadow replicas ，ES 节点不会做实际的索引操作，而是单纯的每次 flush 时，把 segment 内容 fsync 到共享存储磁盘上。然后 refresh 让其他节点能够搜索该 segment 内容。</p>
<p>如果你已经决定把数据放到共享存储上了，采用 shadow replicas 还是有一些好处的：</p>
<ol>
<li>可以帮助你节省一部分不必要的多副本分片的数据写入压力；</li>
<li>在节点出现异常，需要在其他节点上恢复副本数据的时候，可以避免不必要的网络数据拷贝。</li>
</ol>
<p>但是请注意：主分片节点还是要承担一个副本的写入过程，并不像 Lucene 的 FileReplicator 那样通过复制文件完成，所以达不到完全节省 CPU 的效果。</p>
<p>shadow replicas 只是一个在某些特定环境下有用的方式。在资源允许的情况下，还是应该使用 local gateway。而另外采用 snapshot 接口来完成数据长期备份到 HDFS 或其他共享存储的需要。</p>
<h1 id="集群状态维护"><a href="#集群状态维护" class="headerlink" title="集群状态维护"></a>集群状态维护</h1><p>我们都知道，ES 中的 master 跟一般 MySQL、Hadoop 的 master 是不一样的。它即不是写入流量的唯一入口，也不是所有数据的元信息的存放地点。所以，一般来说，ES 的 master 节点负载很轻，集群性能是可以近似认为随着 data 节点的扩展线性提升的。</p>
<p>但是，上面这句话并不是完全正确的。</p>
<p>ES 中有一件事情是只有 master 节点能管理的，这就是集群状态(cluster state)。</p>
<p>集群状态中包括以下信息：</p>
<ul>
<li>集群层面的设置</li>
<li>集群内有哪些节点</li>
<li>各索引的设置，映射，分析器和别名等</li>
<li>索引内各分片所在的节点位置</li>
</ul>
<p>这些信息在集群的任意节点上都存放着，你也可以通过 <code>/_cluster/state</code> 接口直接读取到其内容。注意这最后一项信息，之前我们已经讲过 ES 怎么通过简单地取余知道一条数据放在哪个分片里，加上现在集群状态里又记载了分片在哪个节点上，那么，整个集群里，任意节点都可以知道一条数据在哪个节点上存储了。所以，数据读写才可以发送给集群里任意节点。</p>
<p>至于修改，则只能由 master 节点完成！显然，集群状态里大部分内容是极少变动的，唯独有一样除外——索引的映射。因为 ES 的 schema-less 特性，我们可以任意写入 JSON 数据，所以索引中随时可能增加新的字段。这个时候，负责容纳这条数据的主分片所在的节点，会暂停写入操作，将字段的映射结果传递给 master 节点；master 节点合并这段修改到集群状态里，发送新版本的集群状态到集群的所有节点上。然后写入操作才会继续。一般来说，这个操作是在一二十毫秒内就可以完成，影响也不大。</p>
<p>但是也有一些情况会是例外。</p>
<h2 id="批量新索引创建"><a href="#批量新索引创建" class="headerlink" title="批量新索引创建"></a>批量新索引创建</h2><p>在较大规模的 Elastic Stack 应用场景中，这是比较常见的一个情况。因为 Elastic Stack 建议采用日期时间作为索引的划分方式，所以定时(一般是每天)，会统一产生一批新的索引。而前面已经讲过，ES 的集群状态每次更新都是阻塞式的发布到全部节点上以后，节点才能继续后续处理。</p>
<p>这就意味着，如果在集群负载较高的时候，批量新建新索引，可能会有一个显著的阻塞时间，无法写入任何数据。要等到全部节点同步完成集群状态以后，数据写入才能恢复。</p>
<p>不巧的是，中国使用的是北京时间，UTC +0800。也就是说，默认的 Elastic Stack 新建索引时间是在早上 8 点。这个时间点一般日志写入量已经上涨到一定水平了(当然，晚上 0 点的量其实也不低)。</p>
<p>对此，可以通过定时任务，每天在最低谷的早上三四点，提前通过 POST mapping 的方式，创建好之后几天的索引。就可以避免这个问题了。</p>
<p><strong>如果你的日志是比较严重的非结构化数据，这个问题在 2.0 版本后会变得更加严重。</strong> Elasticsearch 从 2.0 版本开始，对 mapping 更新做了重构。为了防止字段类型冲突和减少 master 定期下发全量 cluster state 导致的大流量压力，新的实现和旧实现的区别在：</p>
<ul>
<li>过去：每次 bulk 请求，本地生成索引后，将更新的 mapping，按照 <code>_type</code> 为单位构成 mapping 更新请求发给 master；</li>
<li>现在：每次 bulk 请求，遍历每条数据，将每条数据要更新的 mapping，都单独发给 master，等到 master 通知完全集群，本地才能生成这一条数据的索引。</li>
</ul>
<p>也就是说，一旦你日志中字段数量较多，在新创建索引的一段时间内，可能长达几十分钟一直被反复锁死！</p>
<h2 id="过多字段持续更新"><a href="#过多字段持续更新" class="headerlink" title="过多字段持续更新"></a>过多字段持续更新</h2><p>这是另一种常见的滥用。在使用 Elastic Stack 处理访问日志时，为了查询更方便，可能会采用 logstash-filter-kv 插件，将访问日志中的每个 URL 参数，都切分成单独的字段。比如一个 “/index.do?uid=1234567890&amp;action=payload” 的 URL 会被转换成如下 JSON：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;urlpath&quot; : &quot;/index.do&quot;,</div><div class="line">&quot;urlargs&quot; : &#123;</div><div class="line">  &quot;uid&quot; : &quot;1234567890&quot;,</div><div class="line">  &quot;action&quot; : &quot;payload&quot;,</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，因为集群状态是存在所有节点的内存里的，一旦 URL 参数过多，ES 节点的内存就被大量用于存储字段映射内容。这是一个极大的浪费。如果碰上 URL 参数的键内容本身一直在变动，直接撑爆 ES 内存都是有可能的！</p>
<p><em>以上是真实发生的事件，开发人员莫名的选择将一个 UUID 结果作为 key 放在 URL 参数里。直接导致 ES 集群 master 节点全部 OOM。</em></p>
<p>如果你在 ES 日志中一直看到有新的 <code>updating mapping [logstash-2015.06.01]</code> 字样出现的话，请郑重考虑一下自己是不是用的上如此细分的字段列表吧。</p>
<p>好，三秒钟过去，如果你确定一定以及肯定还要这么做，下面是一个变通的解决办法。</p>
<h3 id="nested-object"><a href="#nested-object" class="headerlink" title="nested object"></a>nested object</h3><p>用 nested object 来存放 URL 参数的方法稍微复杂，但还可以接受。单从 JSON 数据层面看，新方式的数据结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;urlargs&quot;: [</div><div class="line">  &#123; &quot;key&quot;: &quot;uid&quot;, &quot;value&quot;: &quot;1234567890&quot; &#125;,</div><div class="line">  &#123; &quot;key&quot;: &quot;action&quot;, &quot;value&quot;: &quot;payload&quot; &#125;,</div><div class="line">  ...</div><div class="line">]</div></pre></td></tr></table></figure>
<p>没错，看起来就是一个数组。但是 JSON 数组在 ES 里是有两种处理方式的。</p>
<p>如果直接写入数组，ES 在实际索引过程中，会把所有内容都平铺开，变成 <strong>Arrays of Inner Objects</strong>。整条数据实际类似这样的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;urlpath&quot; : [&quot;/index.do&quot;],</div><div class="line">  &quot;urlargs.key&quot; : [&quot;uid&quot;, &quot;action&quot;, ...],</div><div class="line">  &quot;urlargs.value&quot; : [&quot;1234567890&quot;, &quot;payload&quot;, ...]</div></pre></td></tr></table></figure>
<p>这种方式最大的问题是，当你采用 <code>urlargs.key:&quot;uid&quot; AND urlargs.value:&quot;0987654321&quot;</code> 语句意图搜索一个 uid=0987654321 的请求时，实际是整个 URL 参数中任意一处 value 为 0987654321 的，都会命中。</p>
<p>要想达到正确搜索的目的，需要在写入数据之前，指定 urlargs 字段的映射类型为 nested object。命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">curl -XPOST http://127.0.0.1:9200/logstash-2015.06.01/_mapping -d &apos;&#123;</div><div class="line">  &quot;accesslog&quot; : &#123;</div><div class="line">    &quot;properties&quot; : &#123;</div><div class="line">      &quot;urlargs&quot; : &#123;</div><div class="line">        &quot;type&quot; : &quot;nested&quot;,</div><div class="line">        &quot;properties&quot; : &#123;</div><div class="line">            &quot;key&quot; : &#123; &quot;type&quot; : &quot;string&quot;, &quot;index&quot; : &quot;not_analyzed&quot;, &quot;doc_values&quot; : true &#125;,</div><div class="line">            &quot;value&quot; : &#123; &quot;type&quot; : &quot;string&quot;, &quot;index&quot; : &quot;not_analyzed&quot;, &quot;doc_values&quot; : true &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125; </div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>这样，数据实际是类似这样的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;urlpath&quot; : [&quot;/index.do&quot;],</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">  &quot;urlargs.key&quot; : [&quot;uid&quot;],</div><div class="line">  &quot;urlargs.value&quot; : [&quot;1234567890&quot;],</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">  &quot;urlargs.key&quot; : [&quot;action&quot;],</div><div class="line">  &quot;urlargs.value&quot; : [&quot;payload&quot;],</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，nested object 节省字段映射的优势对应的是它在使用的复杂。Query 和 Aggs 都必须使用专门的 nested query 和 nested aggs 才能正确读取到它。</p>
<p>nested query 语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">curl -XPOST http://127.0.0.1:9200/logstash-2015.06.01/accesslog/_search -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;urlpath&quot; : &quot;/index.do&quot; &#125;&#125;, </div><div class="line">        &#123;</div><div class="line">          &quot;nested&quot;: &#123;</div><div class="line">            &quot;path&quot;: &quot;urlargs&quot;, </div><div class="line">            &quot;query&quot;: &#123;</div><div class="line">              &quot;bool&quot;: &#123;</div><div class="line">                &quot;must&quot;: [ </div><div class="line">                  &#123; &quot;match&quot;: &#123; &quot;urlargs.key&quot;: &quot;uid&quot; &#125;&#125;,</div><div class="line">                  &#123; &quot;match&quot;: &#123; &quot;urlargs.value&quot;: &quot;1234567890&quot; &#125;&#125;</div><div class="line">                ]</div><div class="line">        &#125;&#125;&#125;&#125;</div><div class="line">      ]</div><div class="line">&#125;&#125;&#125;&apos;</div></pre></td></tr></table></figure>
<p>nested aggs 语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">curl -XPOST http://127.0.0.1:9200/logstash-2015.06.01/accesslog/_search -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;topnuid&quot;: &#123;</div><div class="line">      &quot;nested&quot;: &#123;</div><div class="line">        &quot;path&quot;: &quot;urlargs&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;uid&quot;: &#123;</div><div class="line">          &quot;filter&quot;: &#123;</div><div class="line">            &quot;term&quot;: &#123;</div><div class="line">              &quot;urlargs.key&quot;: &quot;uid&quot;,</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;topn&quot;: &#123;</div><div class="line">              &quot;terms&quot;: &#123; </div><div class="line">                &quot;field&quot;: &quot;urlargs.value&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><p>ES 内针对不同阶段，设计有不同的缓存。以此提升数据检索时的响应性能。主要包括节点层面的 filter cache 和分片层面的 request cache。下面分别讲述。</p>
<h2 id="filter-cache"><a href="#filter-cache" class="headerlink" title="filter cache"></a>filter cache</h2><p>ES 的 query DSL 在 2.0 版本之前分为 query 和 filter 两种，很多检索语法，是同时存在 query 和 filter 里的。比如最常用的 term、prefix、range 等。怎么选择是使用 query 还是 filter 成为很多用户头疼的难题。于是从 2.0 版本开始，ES 干脆合并了 filter 统一归为 query。但是具体的检索语法本身，依然有 query 和 filter 上下文的区别。ES 依靠这个上下文判断，来自动决定是否启用 filter cache。</p>
<p>query 跟 filter 上下文的区别，简单来说：</p>
<ul>
<li>query 是要相关性评分的，filter 不要；</li>
<li>query 结果无法缓存，filter 可以。</li>
</ul>
<p>所以，选择也就出来了：</p>
<ul>
<li>全文搜索、评分排序，使用 query；</li>
<li>是非过滤，精确匹配，使用 filter。</li>
</ul>
<p>不过我们要怎么写，才能让 ES 正确判断呢？看下面这个请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># curl -XGET http://127.0.0.1:9200/_search -d &apos;</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;bool&quot;: &#123;</div><div class="line">            &quot;must_not&quot;: [</div><div class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Search&quot; &#125; &#125;</div><div class="line">            ],</div><div class="line">            &quot;must&quot;: [</div><div class="line">                &#123; &quot;match&quot;: &#123; &quot;content&quot;: &quot;Elasticsearch&quot; &#125; &#125;</div><div class="line">            ],</div><div class="line">            &quot;filter&quot;: [</div><div class="line">                &#123; &quot;term&quot;:  &#123; &quot;status&quot;: &quot;published&quot; &#125; &#125;,</div><div class="line">                &#123; &quot;range&quot;: &#123; &quot;publish_date&quot;: &#123; &quot;gte&quot;: &quot;2015-01-01&quot; &#125; &#125; &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>在这个请求中，</p>
<ol>
<li>ES 先看到一个 <strong>query</strong>，那么进入 query 上下文。</li>
<li>然后在 <strong>bool</strong> 里看到一个 <strong>must_not</strong>，那么改进入 filter 上下文，这个有关 title 字段的查询不参与评分。</li>
<li>然后接着是一个 <strong>must</strong> 的 <strong>match</strong>，这个又属于 query 上下文，这个有关 content 字段的查询会影响评分。</li>
<li>最后碰到 <strong>filter</strong>，还属于 filter 上下文，这个有关 status 和 publish_date 字段的查询不参与评分。</li>
</ol>
<p>需要注意的是，filter cache 是节点层面的缓存设置，每个节点上所有数据在响应请求时，是共用一个缓存空间的。当空间用满，按照 LRU 策略淘汰掉最冷的数据。</p>
<p>可以用 <code>indices.cache.filter.size</code> 配置来设置这个缓存空间的大小，默认是 JVM 堆的 10%，也可以设置一个绝对值。注意这是一个静态值，必须在 <code>elasticsearch.yml</code> 中提前配置。</p>
<h2 id="shard-request-cache"><a href="#shard-request-cache" class="headerlink" title="shard request cache"></a>shard request cache</h2><p>ES 还有另一个分片层面的缓存，叫 shard request cache。5.0 之前的版本中，request cache 的用途并不大，因为 query cache 要起作用，还有几个先决条件：</p>
<ol>
<li>分片数据不再变动，也就是对当天的索引是无效的(如果 <code>refresh_interval</code> 很大，那么在这个间隔内倒也算有效)；</li>
<li>使用了 <code>&quot;now&quot;</code> 语法的请求无法被缓存，因为这个是要即时计算的；</li>
<li>缓存的键是请求的整个 JSON 字符串，整个字符串发生任何字节变动，缓存都无效。</li>
</ol>
<p>以 Elastic Stack 场景来说，Kibana 里几乎所有的请求，都是有 <code>@timestamp</code> 作为过滤条件的，而且大多数是以<em>最近 N 小时/分钟</em>这样的选项，也就是说，页面每次刷新，发出的请求 JSON 里的时间过滤部分都是在变动的。query cache 在处理 Kibana 发出的请求时，完全无用。</p>
<p>而 5.0 版本的一大特性，叫 instant aggregation。解决了这个先决条件的一大阻碍。</p>
<p>在之前的版本，Elasticsearch 接收到请求之后，直接把请求原样转发给各分片，由各分片所在的节点自行完成请求的解析，进行实际的搜索操作。所以缓存的键是原始 JSON 串。</p>
<p>而 5.0 的重构后，接收到请求的节点先把请求的解析做完，发送到各节点的是统一拆分修改好的请求，这样就不再担心 JSON 串多个空格啥的了。</p>
<p>其次，上面说的『拆分修改』是怎么回事呢？</p>
<p>比如，我们在 Kibana 里搜索一个最近 7 天(<code>@timestamp:[&quot;now-7d&quot; TO &quot;now&quot;]</code>)的数据，ES 就可以根据按天索引的判断，知道从 6 天前到昨天这 5 个索引是肯定全覆盖的。那么这个横跨 7 天的 <code>date range</code> query 就变成了 5 个 <code>match_all</code> query 加 2 个短时间的 <code>date_range</code> query。</p>
<p>现在你的仪表盘过 5 分钟自动刷新一次，再提交上来一次最近 7 天的请求，中间这 5 个 <code>match_all</code> 就完全一样了，直接从 request cache 返回即可，需要重新请求的，只有两头真正在变动的 <code>date_range</code> 了。</p>
<p><em>注1：<code>match_all</code> 不用遍历倒排索引，比直接查询 `@timestamp:</em><code>要快很多。*
*注2：判断覆盖修改为</code>match_all<code>并不是真的按照索引名称，而是 ES 从 2.x 开始提供的</code>field_stats<code>接口可以直接获取到</code>@timestamp` 在本索引内的 max/min 值。当然从概念上如此理解也是可以接受的。*</p>
<h3 id="field-stats-接口"><a href="#field-stats-接口" class="headerlink" title="field_stats 接口"></a>field_stats 接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &quot;http://localhost:9200/logstash-2016.11.25/_field_stats?fields=timestamp&quot;</div></pre></td></tr></table></figure>
<p>响应结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;_shards&quot;: &#123;</div><div class="line">        &quot;total&quot;: 1,</div><div class="line">        &quot;successful&quot;: 1,</div><div class="line">        &quot;failed&quot;: 0</div><div class="line">    &#125;,</div><div class="line">    &quot;indices&quot;: &#123;</div><div class="line">        &quot;logstash-2016.11.25&quot;: &#123;</div><div class="line">            &quot;fields&quot;: &#123;</div><div class="line">                &quot;timestamp&quot;: &#123;</div><div class="line">                    &quot;max_doc&quot;: 1326564,</div><div class="line">                    &quot;doc_count&quot;: 564633,</div><div class="line">                    &quot;density&quot;: 42,</div><div class="line">                    &quot;sum_doc_freq&quot;: 2258532,</div><div class="line">                    &quot;sum_total_term_freq&quot;: -1,</div><div class="line">                    &quot;min_value&quot;: &quot;2008-08-01T16:37:51.513Z&quot;,</div><div class="line">                    &quot;max_value&quot;: &quot;2013-06-02T03:23:11.593Z&quot;,</div><div class="line">                    &quot;is_searchable&quot;: &quot;true&quot;,</div><div class="line">                    &quot;is_aggregatable&quot;: &quot;true&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>和 filter cache 一样，request cache 的大小也是以节点级别控制的，配置项名为 <code>indices.requests.cache.size</code>，其默认值为 <code>1%</code>。</p>
<h1 id="字段数据"><a href="#字段数据" class="headerlink" title="字段数据"></a>字段数据</h1><p>字段数据(fielddata)，在 Lucene 中又叫 uninverted index。我们都知道，搜索引擎会使用倒排索引(inverted index)来映射单词到文档的 ID 号。而同时，为了提供对文档内容的聚合，Lucene 还可以在运行时将每个字段的单词以字典序排成另一个 uninverted index，可以大大加速计算性能。</p>
<p>作为一个加速性能的方式，fielddata 当然是被全部加载在内存的时候最为有效。这也是 ES 默认的运行设置。但是，内存是有限的，所以 ES 同时也需要提供对 fielddata 内存的限额方式：</p>
<ul>
<li>indices.fielddata.cache.size<br>节点用于 fielddata 的最大内存，如果 fielddata 达到该阈值，就会把旧数据交换出去。该参数可以设置百分比或者绝对值。默认设置是不限制，所以强烈建议设置该值，比如 <code>10%</code>。</li>
<li>indices.fielddata.cache.expire<br>进入 fielddata 内存中的数据多久自动过期。注意，因为 ES 的 fielddata 本身是一种数据结构，而不是简单的缓存，所以过期删除 fielddata 是一个非常消耗资源的操作。ES 官方在文档中特意说明，这个参数绝对绝对<strong>不要</strong>设置！</li>
</ul>
<h3 id="Circuit-Breaker"><a href="#Circuit-Breaker" class="headerlink" title="Circuit Breaker"></a>Circuit Breaker</h3><p>Elasticsearch 在 total，fielddata，request 三个层面上都设计有 circuit breaker 以保护进程不至于发生 OOM 事件。在 fielddata 层面，其设置为：</p>
<ul>
<li>indices.breaker.fielddata.limit<br>默认是 JVM 堆内存大小的 60%。注意，为了让设置正常发挥作用，如果之前设置过 <code>indices.fielddata.cache.size</code> 的，一定要确保 <code>indices.breaker.fielddata.limit</code> 的值大于 <code>indices.fielddata.cache.size</code> 的值。否则的话，fielddata 大小一到 limit 阈值就报错，就永远道不了 size 阈值，无法触发对旧数据的交换任务了。</li>
</ul>
<h2 id="doc-values"><a href="#doc-values" class="headerlink" title="doc values"></a>doc values</h2><p>但是相比较集群庞大的数据量，内存本身是远远不够的。为了解决这个问题，ES 引入了另一个特性，可以对精确索引的字段，指定 fielddata 的存储方式。这个配置项叫：<code>doc_values</code>。</p>
<p>所谓 <code>doc_values</code>，其实就是在 ES 将数据写入索引的时候，提前生成好 fielddata 内容，并记录到磁盘上。因为 fielddata 数据是顺序读写的，所以即使在磁盘上，通过文件系统层的缓存，也可以获得相当不错的性能。</p>
<p>注意：因为 <code>doc_values</code> 是在数据写入时即生成内容，所以，它只能应用在精准索引的字段上，因为索引进程没法知道后续会有什么分词器生成的结果。</p>
<p>由于在 Elastic Stack 场景中，<code>doc_values</code> 的使用极其频繁，到 Elasticsearch 5.0 以后，这两者的区别被彻底强化成两个不同字段类型：<code>text</code> 和 <code>keyword</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;myfieldname&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;text&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>等同于过去的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;myfieldname&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;string&quot;,</div><div class="line">    &quot;fielddata&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;myfieldname&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;keyword&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>等同于过去的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;myfieldname&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;string&quot;,</div><div class="line">    &quot;index&quot;: &quot;not_analyzed&quot;,</div><div class="line">    &quot;doc_values&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也就是说，以后的用户，已经不太需要在意 fielddata 的问题了。不过依然有少数情况，你会需要对分词字段做聚合统计的话，你可以在自己接受范围内，开启这个特性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;mappings&quot;: &#123;</div><div class="line">        &quot;my_type&quot;: &#123;</div><div class="line">            &quot;properties&quot;: &#123;</div><div class="line">                &quot;message&quot;: &#123;</div><div class="line">                    &quot;type&quot;: &quot;text&quot;,</div><div class="line">                    &quot;fielddata&quot;: true,</div><div class="line">                    &quot;fielddata_frequency_filter&quot;: &#123;</div><div class="line">                        &quot;min&quot;: 0.1,</div><div class="line">                        &quot;max&quot;: 1.0,</div><div class="line">                        &quot;min_segment_size&quot;: 500</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以看到在上面加了一段 <code>fielddata_frequency_filter</code> 配置，这个配置是 segment 级别的。上面示例的意思是：只有这个 segment 里的文档数量超过 500 个，而且含有该字段的文档数量占该 segment 里的文档数量比例超过 10% 时，才加载这个 segment 的 fielddata。</p>
<p>下面是一个可能有用的对分词字段做聚合的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;http://localhost:9200/logstash-2016.07.18/logs/_search?pretty&amp;terminate_after=10000&amp;size=0&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">    &quot;aggs&quot;: &#123;</div><div class="line">        &quot;group&quot;: &#123;</div><div class="line">            &quot;terms&quot;: &#123;</div><div class="line">                &quot;field&quot;: &quot;punct&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;aggs&quot;: &#123;</div><div class="line">                &quot;keyword&quot;: &#123;</div><div class="line">                    &quot;significant_terms&quot;: &#123;</div><div class="line">                        &quot;size&quot;: 2,</div><div class="line">                        &quot;field&quot;: &quot;message&quot;</div><div class="line">                    &#125;,</div><div class="line">                    &quot;aggs&quot;: &#123;</div><div class="line">                        &quot;hit&quot;: &#123;</div><div class="line">                            &quot;top_hits&quot;: &#123;</div><div class="line">                                &quot;_source&quot;: &#123;</div><div class="line">                                    &quot;include&quot;: [ &quot;message&quot; ]</div><div class="line">                                &#125;,</div><div class="line">                                &quot;size&quot;:1</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>这个示例可以对经过了 <code>logstash-filter-punct</code> 插件处理的数据，获取每种 punct 类型日志的关键词和对应的代表性日志原文。其效果类似 Splunk 的事件模式功能：</p>
<p><img src="http://chenlinux.com/images/uploads/splunk-event-pattern.png" alt=""></p>
<h1 id="curator"><a href="#curator" class="headerlink" title="curator"></a>curator</h1><p>如果经过之前章节的一系列优化之后，数据确实超过了集群能承载的能力，除了拆分集群以外，最后就只剩下一个办法了：清除废旧索引。</p>
<p>为了更加方便的做清除数据，合并 segment，备份恢复等管理任务，Elasticsearch 在提供相关 API 的同时，另外准备了一个命令行工具，叫 curator 。curator 是 Python 程序，可以直接通过 pypi 库安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install elasticsearch-curator</div></pre></td></tr></table></figure>
<p><em>注意，是 elasticsearch-curator 不是 curator。PyPi 原先就有另一个项目叫这个名字</em></p>
<h2 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h2><p>和 Elastic Stack 里其他组件一样，curator 也是被 Elastic.co 收购的原开源社区周边。收编之后同样进行了一次重构，命令行参数从单字母风格改成了长单词风格。新版本的 curator 命令可用参数如下：</p>
<blockquote>
<p>Usage: curator [OPTIONS] COMMAND [ARGS]…</p>
</blockquote>
<p>Options 包括:</p>
<p>  –host TEXT        Elasticsearch host.<br>  –url_prefix TEXT  Elasticsearch http url prefix.<br>  –port INTEGER     Elasticsearch port.<br>  –use_ssl          Connect to Elasticsearch through SSL.<br>  –http_auth TEXT   Use Basic Authentication ex: user:pass<br>  –timeout INTEGER  Connection timeout in seconds.<br>  –master-only      Only operate on elected master node.<br>  –dry-run          Do not perform any changes.<br>  –debug            Debug mode<br>  –loglevel TEXT    Log level<br>  –logfile TEXT     log file<br>  –logformat TEXT   Log output format [default|logstash].<br>  –version          Show the version and exit.<br>  –help             Show this message and exit.</p>
<p>Commands 包括:<br>  alias       Index Aliasing<br>  allocation  Index Allocation<br>  bloom       Disable bloom filter cache<br>  close       Close indices<br>  delete      Delete indices or snapshots<br>  open        Open indices<br>  optimize    Optimize Indices<br>  replicas    Replica Count Per-shard<br>  show        Show indices or snapshots<br>  snapshot    Take snapshots of indices (Backup)</p>
<p>针对具体的 Command，还可以继续使用 <code>--help</code> 查看该子命令的帮助。比如查看 <em>close</em> 子命令的帮助，输入 <code>curator close --help</code>，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Usage: curator close [OPTIONS] COMMAND [ARGS]...</div><div class="line"></div><div class="line">  Close indices</div><div class="line"></div><div class="line">Options:</div><div class="line">  --help  Show this message and exit.</div><div class="line"></div><div class="line">Commands:</div><div class="line">  indices  Index selection.</div></pre></td></tr></table></figure>
<h2 id="常用示例"><a href="#常用示例" class="headerlink" title="常用示例"></a>常用示例</h2><p>在使用 1.4.0 以上版本的 Elasticsearch 前提下，curator 曾经主要的一个子命令 <code>bloom</code> 已经不再需要使用。所以，目前最常用的三个子命令，分别是 <code>close</code>, <code>delete</code> 和 <code>optimize</code>，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curator --timeout 36000 --host 10.0.0.100 delete indices --older-than 5 --time-unit days --timestring &apos;%Y.%m.%d&apos; --prefix logstash-mweibo-nginx-</div><div class="line">curator --timeout 36000 --host 10.0.0.100 delete indices --older-than 10 --time-unit days --timestring &apos;%Y.%m.%d&apos; --prefix logstash-mweibo-client- --exclude &apos;logstash-mweibo-client-2015.05.11&apos;</div><div class="line">curator --timeout 36000 --host 10.0.0.100 delete indices --older-than 30 --time-unit days --timestring &apos;%Y.%m.%d&apos; --regex &apos;^logstash-mweibo-\d+&apos;</div><div class="line">curator --timeout 36000 --host 10.0.0.100 close indices --older-than 7 --time-unit days --timestring &apos;%Y.%m.%d&apos; --prefix logstash-</div><div class="line">curator --timeout 36000 --host 10.0.0.100 optimize --max_num_segments 1 indices --older-than 1 --newer-than 7 --time-unit days --timestring &apos;%Y.%m.%d&apos; --prefix logstash-</div></pre></td></tr></table></figure>
<p>这一顿任务，结果是：</p>
<p><em>logstash-mweibo-nginx-yyyy.mm.dd</em> 索引保存最近 5 天，<em>logstash-mweibo-client-yyyy.mm.dd</em> 保存最近 10 天，<em>logstash-mweibo-yyyy.mm.dd</em> 索引保存最近 30 天；且所有七天前的 <em>logstash-*</em> 索引都暂时关闭不用；最后对所有非当日日志做 segment 合并优化。</p>
<h1 id="profiler"><a href="#profiler" class="headerlink" title="profiler"></a>profiler</h1><p>profiler 是 Elasticsearch 5.0 的一个新接口。通过这个功能，可以看到一个搜索聚合请求，是如何拆分成底层的 Lucene 请求，并且显示每部分的耗时情况。</p>
<p>启用 profiler 的方式很简单，直接在请求里加一行即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;http://localhost:9200/_search&apos; -d &apos;&#123;</div><div class="line">    &quot;profile&quot;: true,</div><div class="line">    &quot;query&quot;: &#123; ... &#125;,</div><div class="line">    &quot;aggs&quot;: &#123; ... &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>可以看到其中对 query 和 aggs 部分的返回是不太一样的。</p>
<h2 id="query"><a href="#query" class="headerlink" title="query"></a>query</h2><p>query 部分包括 collectors、rewrite 和 query 部分。对复杂 query，profiler 会拆分 query 成多个基础的 TermQuery，然后每个 TermQuery 再显示各自的分阶段耗时如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&quot;breakdown&quot;: &#123;</div><div class="line">    &quot;score&quot;: 51306,</div><div class="line">    &quot;score_count&quot;: 4,</div><div class="line">    &quot;build_scorer&quot;: 2935582,</div><div class="line">    &quot;build_scorer_count&quot;: 1,</div><div class="line">    &quot;match&quot;: 0,</div><div class="line">    &quot;match_count&quot;: 0,</div><div class="line">    &quot;create_weight&quot;: 919297,</div><div class="line">    &quot;create_weight_count&quot;: 1,</div><div class="line">    &quot;next_doc&quot;: 53876,</div><div class="line">    &quot;next_doc_count&quot;: 5,</div><div class="line">    &quot;advance&quot;: 0,</div><div class="line">    &quot;advance_count&quot;: 0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="aggs"><a href="#aggs" class="headerlink" title="aggs"></a>aggs</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&quot;time&quot;: &quot;1124.864392ms&quot;,</div><div class="line">&quot;breakdown&quot;: &#123;</div><div class="line">    &quot;reduce&quot;: 0,</div><div class="line">    &quot;reduce_count&quot;: 0,</div><div class="line">    &quot;build_aggregation&quot;: 1394,</div><div class="line">    &quot;build_aggregation_count&quot;: 150,</div><div class="line">    &quot;initialise&quot;: 2883,</div><div class="line">    &quot;initialize_count&quot;: 150,</div><div class="line">    &quot;collect&quot;: 1124860115,</div><div class="line">    &quot;collect_count&quot;: 900</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以很明显的看到聚合统计在初始化阶段、收集阶段、构建阶段、汇总阶段分别花了多少时间，遍历了多少数据。</p>
<p><em>注意其中 reduce 阶段还没实现完毕，所有都是 0。因为目前 profiler 只能在 shard 级别上做统计。</em></p>
<p>collect 阶段的耗时，有助于我们调整对应 aggs 的 <code>collect_mode</code> 参数选择。目前 Elasticsearch 支持 <code>breadth_first</code> 和 <code>depth_first</code> 两种方式。</p>
<p>initialise 阶段的耗时，有助于我们调整对应 aggs 的 <code>execution_hint</code> 参数选择。目前 Elasticsearch 支持 <code>map</code>、<code>global_ordinals_low_cardinality</code>、<code>global_ordinals</code> 和 <code>global_ordinals_hash</code> 四种选择。在计算离散度比较大的字段统计值时，适当调整该参数，有益于节省内存和提高计算速度。</p>
<p><em>对高离散度字段值统计性能很关注的读者，可以关注 <a href="https://github.com/elastic/elasticsearch/pull/21626" target="_blank" rel="external">https://github.com/elastic/elasticsearch/pull/21626</a> 这条记录的进展。</em></p>
<p>（本文完）</p>
<p>文本整理自《ELKstack权威指南》</p>

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Elasticsearch/">Elasticsearch</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/post/lucene-study-note/"  data-tooltip="Lucene学习笔记">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/post/elkstack-es02/" data-tooltip="Elasticsearch数据接口用例">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-facebook-official"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-twitter"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-google-plus"></i>
                </a>
            </li>
        
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 Ghost Stories. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/post/lucene-study-note/"  data-tooltip="Lucene学习笔记">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/post/elkstack-es02/" data-tooltip="Elasticsearch数据接口用例">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-facebook-official"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-twitter"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-google-plus"></i>
                </a>
            </li>
        
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <i id="btn-close-shareoptions" class="fa fa-close"></i>
    <ul class="share-options">
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-twitter"></i><span>Share on Twitter</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://wangnan.tech/post/elkstack-es03/">
                    <i class="fa fa-google-plus"></i><span>Share on Google+</span>
                </a>
            </li>
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/ice_bear.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Ghost Stories</h4>
        
            <div id="about-card-bio"><p>2gether thru life</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Backend Engineer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Nanjing,China
            </div>
        
    </div>
</div>

        <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-close"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/elasticsearch-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/elasticsearch.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/elasticsearch-introduction/">
                            <h3 class="media-heading">Elasticsearch简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    May 8, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/mybatis-getting-started/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/mybatis.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/mybatis-getting-started/">
                            <h3 class="media-heading">Java项目中使用Mybatis入门程序</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    May 18, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/tool-swagger-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/03.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/tool-swagger-introduction/">
                            <h3 class="media-heading">Swagger简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    May 23, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/tool-Sublime-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/25.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/tool-Sublime-introduction/">
                            <h3 class="media-heading">Sublime Text 3简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    May 28, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-reflection-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/java.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-reflection-introduction/">
                            <h3 class="media-heading">Java反射简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 8, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/redis-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/redis.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/redis-introduction/">
                            <h3 class="media-heading">Redis初识</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 13, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-proxy-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/java.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-proxy-introduction/">
                            <h3 class="media-heading">Java代理简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 13, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-annotation-introduction/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/java.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-annotation-introduction/">
                            <h3 class="media-heading">Java注解简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 18, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-ThreadLocal/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/java.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/java-ThreadLocal/">
                            <h3 class="media-heading">Java ThreadLocal 简介</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 23, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://wangnan.tech/post/read-youth/">
                            <img class="media-image" src="http://onxkn9cbz.bkt.clouddn.com/photo08.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://wangnan.tech/post/read-youth/">
                            <h3 class="media-heading">《年轻可以一无所有》书摘</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 28, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><!-- toc --></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="no post found"
                data-message-one="1 post found"
                data-message-other="{n} posts found">
                113 posts found
            </p>
        </div>
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-ivwiy10zeb8fifc4swnhkwneuk64y53w2scmdmtp8thi9cqfxh31aowtroaz.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://wangnan.tech/post/elkstack-es03/';
                 
                    this.page.identifier = 'post/elkstack-es03/';
                 
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'wangnan9279';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    


    </body>
</html>
